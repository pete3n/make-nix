# Make-nix
A make controlled, NixOS, Nix-Darwin, and Home-manager configuration management system.

## About
I wanted an easy way to manage and deploy flake-based Nix configurations for NixOS, 
Nix-Darwin, and non-NixOS Linux distributions, so I created a central Makefile to manage
all aspects of installing, building and deploying Nix!

### How does it work?
The flake.nix configuration imports build-target.nix. This file contains an attribute 
set generated by the Makefile. This is where the imperative options provided by the user 
are bridged with the declarative configuration. 

## Makefile documentation
To view the Makefile documentation in your terminal, run:
```
make
```
or

```
make usage
```

<details>
<summary>ðŸ“˜ <strong>make-nix usage</strong></summary>

### **Usage**

```sh
make <help|install|home|system|all|test>
     [TGT_USER=<user>]
     [TGT_HOST=<host>]
     [TGT_TAGS=<tag1>,<tag2>,<tag3>,...]
     [TGT_SYSTEM=<system>]
     [TGT_SPEC=<spc1>,<spc2>,<spc3>,...]
     [OPTION FLAGS]
```

---

### **Make Targets**

| Target    | Description                                                       |
|-----------|-------------------------------------------------------------------|
| `help`    | View make-nix usage help.                                                     |
| `install` | Install Nix and/or Nix-Darwin.                                    |
| `home`    | Build and activate a Home-manager configuration.                  |
| `system`  | Build and activate a NixOS or Nix-Darwin system configuration.    |
| `all`     | Execute both the system and home targets in that order.           |
| `test`    | Check all flake configurations.                                   |

---

### **Configuration Parameters**

| Variable     | Description |
|--------------|-------------|
| `TGT_USER`   | User configuration (current user will be passed by default). |
| `TGT_HOST`   | System configuration host (current hostname will be passed by default). |
| `TGT_SYSTEM` | System platform to target for builds: `x86_64-linux`, `aarch64-linux`, `x86_64-darwin`, or `aarch64-darwin` (current platform will be passed by default). |
| `TGT_SPEC`   | Comma-separated list of system specialisation configurations (no spaces). |
| `TGT_TAGS`   | Customize home-manager user configuration based on tags, similar to specialisations for system configurations. |

---

### **Target Option Flags**

These are **boolean**; assigning any *truthy* value will enable them.

> **Truthy values:** `1`, `yes`, `Yes`, `YES`, `true`, `True`, `TRUE`, `on`, `On`, `ON`, `y`, `Y`

#### **Install Flags**
- `DETERMINATE=true` â€“ Install Nix using the Determinate Systems installer.
- `NIX_DARWIN=true` â€“ Install Nix-Darwin for macOS.
- `SINGLE_USER=true` â€“ Install Nix for single-user mode (default installer only).

#### **Configuration Flags**
- `DRY_RUN=true` â€“ Evaluate the new configuration but don't activate it.
- `HOME_ALONE=true` â€“ Configure options for a system running home-manager without NixOS or Nix-Darwin.
- `BOOT_SPEC=true` â€“ Set the default boot menu option to the **first** listed specialisation.  
  _**Note:** Only supports systemd-boot configurations._

#### **Additional Flags**
- `KEEP_LOGS=true` â€“ Don't erase logs after operations (for debugging).

---

### **Usage Examples**

```sh
# Install Nix using the default installer for single-user mode:
make install SINGLE_USER=Y

# Install Nix-Darwin using the Determinate Systems installer:
make install DETERMINATE=1 NIX_DARWIN=y

# Build and activate the home-manager config using a standalone configuration:
make home HOME_ALONE=true

# Build and activate the current system configuration:
make system

# Standalone home-manager config for user `sam` on host `xps-15`, with tags and platform:
make home user=sam host=xps-15 system=aarch64-linux HOME_ALONE=1 tags=debian,server

# Rebuild and switch system with specialisations and boot default:
make system host=workstation1 spec=wayland,x11_egpu BOOT_SPEC=1

# Rebuild and switch both system and home-manager configs:
make all

# Evaluate (but do not activate) all configurations:
make all DRY_RUN=1

# Run `nix flake check` for all configurations:
make test
```
</details>
